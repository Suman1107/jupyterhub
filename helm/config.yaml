# JupyterHub Helm Configuration

proxy:
  service:
    type: ClusterIP
  secretToken: "a6047d5c94246754c3154376e212306417857425185574251855742518557425"

hub:
  config:
    Authenticator:
      admin_users:
        - admin
      # Allow anyone to sign up and login immediately
      open_signup: true
      allowed_users: []
    JupyterHub:
      authenticator_class: nativeauthenticator.NativeAuthenticator
      # Configure logging level
      log_level: INFO
  
  # Override the command to redirect stderr to stdout
  # This is the only reliable way to fix GCP Cloud Logging severity
  command:
    - sh
    - -c
    - "exec jupyterhub --config /usr/local/etc/jupyterhub/jupyterhub_config.py 2>&1"

singleuser:
  # Service Account for Workload Identity
  serviceAccountName: jupyter-user-sa
  
  # Enable GCS FUSE sidecar injection
  extraAnnotations:
    gke-gcsfuse/volumes: "true"
  
  # 1. Individual User PDs
  storage:
    type: dynamic
    capacity: 10Gi
    homeMountPath: /home/jovyan
    dynamic:
      storageClass: standard-rwo
      pvcNameTemplate: claim-{username}{servername}
      volumeNameTemplate: volume-{username}{servername}
      storageAccessModes: [ReadWriteOnce]
    
  # 3. Shared GCS Bucket
    extraVolumes:
      - name: shared-data
        csi:
          driver: gcsfuse.csi.storage.gke.io
          volumeAttributes:
            bucketName: suman-110797-jupyterhub-shared
            mountOptions: "implicit-dirs"
    extraVolumeMounts:
      - name: shared-data
        mountPath: /home/jovyan/shared
        readOnly: false
  
  # Configure Jupyter server logging - redirect stderr to stdout for proper GCP severity
  cmd:
    - sh
    - -c
    - "exec jupyterhub-singleuser 2>&1"
  
  extraEnv:
    # Configure Python logging to use stdout
    PYTHONUNBUFFERED: "1"
    # Set log level
    JUPYTER_LOG_LEVEL: "INFO"

  extraContainers:
    - name: cloud-sql-proxy
      image: gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.14.2
      args:
        - "--private-ip"
        - "--structured-logs"
        - "--port=5432"
        - "suman-110797:us-central1:jupyterhub-db-instance"
        - "--auto-iam-authn"
      securityContext:
        runAsNonRoot: true
      resources:
        requests:
          memory: "256Mi"
          cpu: "100m"

  # 4. Security Best Practices
  networkPolicy:
    enabled: true
    egress:
      - ports:
          - port: 53
            protocol: UDP
          - port: 53
            protocol: TCP
      - ports:
          - port: 80
            protocol: TCP
          - port: 443
            protocol: TCP

  cpu:
    guarantee: 0.5
    limit: 2
  memory:
    guarantee: 1G
    limit: 4G
  
  cloudMetadata:
    blockWithIptables: false

scheduling:
  userScheduler:
    enabled: true
  podPriority:
    enabled: true

prePuller:
  hook:
    enabled: true
  continuous:
    enabled: false  # Disabled to prevent CrashLoopBackOff with Cloud SQL Proxy image
