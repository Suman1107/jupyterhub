# JupyterHub Helm Configuration

proxy:
  service:
    type: ClusterIP
  secretToken: "a6047d5c94246754c3154376e212306417857425185574251855742518557425"

hub:
  config:
    Authenticator:
      admin_users:
        - admin
      # Allow anyone to sign up and login immediately
      open_signup: true
      allowed_users: []
    JupyterHub:
      authenticator_class: nativeauthenticator.NativeAuthenticator
      # Configure logging to use stdout with proper severity levels
      log_level: INFO
      log_format: "%(color)s[%(levelname)1.1s %(asctime)s.%(msecs).03d %(name)s %(module)s:%(lineno)d]%(end_color)s %(message)s"
  
  # Additional logging configuration for proper GCP Cloud Logging integration
  extraConfig:
    logging: |
      import logging
      import sys
      
      # Configure root logger to use stdout instead of stderr
      # This ensures GCP Cloud Logging interprets severity correctly
      c.Application.log_datefmt = '%Y-%m-%d %H:%M:%S'
      c.Application.log_format = '[%(levelname)s %(asctime)s.%(msecs)03d %(name)s] %(message)s'
      
      # Ensure logs go to stdout (not stderr) so GCP interprets severity correctly
      logging.basicConfig(
          stream=sys.stdout,
          level=logging.INFO,
          format='[%(levelname)s %(asctime)s.%(msecs)03d %(name)s] %(message)s',
          datefmt='%Y-%m-%d %H:%M:%S'
      )

singleuser:
  # Service Account for Workload Identity
  serviceAccountName: jupyter-user-sa
  
  # Enable GCS FUSE sidecar injection
  extraAnnotations:
    gke-gcsfuse/volumes: "true"
  
  # 1. Individual User PDs
  storage:
    type: dynamic
    capacity: 10Gi
    homeMountPath: /home/jovyan
    dynamic:
      storageClass: standard-rwo
      pvcNameTemplate: claim-{username}{servername}
      volumeNameTemplate: volume-{username}{servername}
      storageAccessModes: [ReadWriteOnce]
    
  # 3. Shared GCS Bucket
    extraVolumes:
      - name: shared-data
        csi:
          driver: gcsfuse.csi.storage.gke.io
          volumeAttributes:
            bucketName: suman-110797-jupyterhub-shared
            mountOptions: "implicit-dirs"
    extraVolumeMounts:
      - name: shared-data
        mountPath: /home/jovyan/shared
        readOnly: false
  
  # Configure Jupyter server logging to use stdout with proper levels
  cmd:
    - jupyterhub-singleuser
    - --debug  # Enable debug mode for better logging
  
  extraEnv:
    # Configure Python logging to use stdout
    PYTHONUNBUFFERED: "1"
    # Set log level
    JUPYTER_LOG_LEVEL: "INFO"

  extraContainers:
    - name: cloud-sql-proxy
      image: gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.14.2
      args:
        - "--private-ip"
        - "--structured-logs"
        - "--port=5432"
        - "suman-110797:us-central1:jupyterhub-db-instance"
        - "--auto-iam-authn"
      securityContext:
        runAsNonRoot: true
      resources:
        requests:
          memory: "256Mi"
          cpu: "100m"

  # 4. Security Best Practices
  networkPolicy:
    enabled: true
    egress:
      - ports:
          - port: 53
            protocol: UDP
          - port: 53
            protocol: TCP
      - ports:
          - port: 80
            protocol: TCP
          - port: 443
            protocol: TCP

  cpu:
    guarantee: 0.5
    limit: 2
  memory:
    guarantee: 1G
    limit: 4G
  
  cloudMetadata:
    blockWithIptables: false

scheduling:
  userScheduler:
    enabled: true
  podPriority:
    enabled: true

prePuller:
  hook:
    enabled: true
  continuous:
    enabled: false  # Disabled to prevent CrashLoopBackOff with Cloud SQL Proxy image
